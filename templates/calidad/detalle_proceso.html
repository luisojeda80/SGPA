{% extends "base.html" %}
{% from "_form_helpers.html" import render_field %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
    <a href="{{ url_for('calidad.listar_procesos') }}" class="btn btn-sm btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver a la Lista
    </a>
</div>

<div class="row">
    <!-- Columna de Información y Añadir Fardo -->
    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">Datos del Proceso</h5></div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Productor:</strong> {{ proceso.carga.productor.nombre_completo }}</li>
                    <li class="list-group-item"><strong>Fecha Proceso:</strong> {{ proceso.fecha_proceso.strftime('%d/%m/%Y') }}</li>
                    <li class="list-group-item"><strong>Fibra Obtenida:</strong> {{ "%.2f"|format(proceso.kilos_fibra) }} kg</li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">Añadir Nuevo Fardo</h5></div>
            <div class="card-body">
                <form method="POST" novalidate>
                    {{ form.hidden_tag() }}
                    {{ render_field(form.peso, class="form-control") }}
                    <div class="d-grid">
                        {{ form.submit(class="btn btn-primary mt-2") }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Columna de Fardos Registrados -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">Fardos Registrados ({{ proceso.fardos.count() }})</h5></div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>N° Fardo</th>
                            <th>Peso (kg)</th>
                            <th>Grado Calidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fardo in proceso.fardos.order_by('numero_fardo') %}
                        <tr>
                            <td><strong>{{ fardo.numero_fardo }}</strong></td>
                            <td>{{ "%.2f"|format(fardo.peso) }}</td>
                            <td>
                                {% if fardo.clasificacion %}
                                    <span class="badge bg-success">Grado {{ fardo.clasificacion.grado }}</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Sin Clasificar</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if fardo.clasificacion %}
                                <a href="{{ url_for('calidad.editar_clasificacion', fardo_id=fardo.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar Clasificación">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                {% else %}
                                <a href="{{ url_for('calidad.clasificar_fardo', fardo_id=fardo.id) }}" class="btn btn-sm btn-outline-primary" title="Clasificar Fardo">
                                    <i class="bi bi-check2-square"></i> Clasificar
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">No hay fardos registrados para este proceso.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}