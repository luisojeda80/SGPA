{% extends "base.html" %}

{% block title %}Liquidación desde Carga - SGPA{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Liquidación desde Carga Procesada</h1>
                <a href="{{ url_for('liquidacion.lotes_pendientes') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>

            <!-- Información de la Carga -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-box me-2"></i>Información del Lote</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Lote ID:</strong><br>
                            <span class="fs-5">{{ carga.lote_id }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Productor:</strong><br>
                            {{ carga.productor.nombre_completo }}
                        </div>
                        <div class="col-md-3">
                            <strong>Peso Neto:</strong><br>
                            {{ "%.2f"|format(carga.peso_neto) }} kg
                        </div>
                        <div class="col-md-3">
                            <strong>Rendimiento:</strong><br>
                            <span class="badge bg-{% if carga.proceso_desmotado.rendimiento >= 33 %}success{% else %}warning{% endif %}">
                                {{ "%.1f"|format(carga.proceso_desmotado.rendimiento) }}%
                            </span>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <strong>Fibra Producida:</strong><br>
                            {{ "%.2f"|format(carga.proceso_desmotado.kilos_fibra) }} kg
                        </div>
                        <div class="col-md-4">
                            <strong>Semilla Producida:</strong><br>
                            {{ "%.2f"|format(carga.proceso_desmotado.kilos_semilla) }} kg
                        </div>
                        <div class="col-md-4">
                            <strong>Fecha Proceso:</strong><br>
                            {{ carga.proceso_desmotado.fecha_proceso.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Liquidación -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Completar Datos de Liquidación</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="liquidacionForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Datos Básicos -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 text-primary">Datos de Identificación</h6>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.numero_ticket_balanza.label(class="form-label") }}
                                    {{ form.numero_ticket_balanza(class="form-control") }}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.numero_romaneo.label(class="form-label") }}
                                    {{ form.numero_romaneo(class="form-control") }}
                                </div>
                            </div>
                        </div>

                        <!-- Precios y Calidad -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 text-warning">Precios y Calidad</h6>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.calidad_algodon.label(class="form-label") }}
                                    {{ form.calidad_algodon(class="form-select", id="calidad_algodon") }}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.precio_por_tonelada.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.precio_por_tonelada(class="form-control", id="precio_tonelada") }}
                                        <span class="input-group-text">/tn</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Total Bruto Calculado</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control" id="total_bruto_calculado" readonly 
                                               value="{{ (carga.proceso_desmotado.kilos_fibra / 1000 * 200)|round(2) }}">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gastos -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 text-danger">Gastos Asociados</h6>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.deuda_semilla.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.deuda_semilla(class="form-control") }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.descuento_prestamos.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.descuento_prestamos(class="form-control") }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.adelantos.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.adelantos(class="form-control") }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.otros_gastos.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.otros_gastos(class="form-control") }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.descripcion_otros_gastos.label(class="form-label") }}
                                    {{ form.descripcion_otros_gastos(class="form-control", rows="2", placeholder="Descripción de otros gastos...") }}
                                </div>
                            </div>
                        </div>

                        <!-- Forma de Pago -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 text-info">Forma de Pago</h6>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.forma_pago.label(class="form-label") }}
                                    {{ form.forma_pago(class="form-select") }}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.banco_destino.label(class="form-label") }}
                                    {{ form.banco_destino(class="form-control", placeholder="Nombre del banco") }}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.cuenta_destino.label(class="form-label") }}
                                    {{ form.cuenta_destino(class="form-control", placeholder="Número de cuenta o CBU") }}
                                </div>
                            </div>
                        </div>

                        <!-- Resumen -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="mb-0">Resumen de Liquidación</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4 text-center">
                                                <h6>Algodón Bruto</h6>
                                                <h4 class="text-primary">{{ "%.0f"|format(carga.peso_neto) }} kg</h4>
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <h6>Fibra Producida</h6>
                                                <h4 class="text-success">{{ "%.0f"|format(carga.proceso_desmotado.kilos_fibra) }} kg</h4>
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <h6>Rendimiento</h6>
                                                <h4 class="text-warning">{{ "%.1f"|format(carga.proceso_desmotado.rendimiento) }}%</h4>
                                            </div>
                                        </div>
                                        <div class="row mt-3 text-center">
                                            <div class="col-md-4">
                                                <h6>Total Bruto</h6>
                                                <h4 class="text-primary" id="resumen_total_bruto">$ 0.00</h4>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Total Gastos</h6>
                                                <h4 class="text-danger" id="resumen_total_gastos">$ 0.00</h4>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Neto a Pagar</h6>
                                                <h4 class="text-success" id="resumen_neto_pagar">$ 0.00</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('liquidacion.lotes_pendientes') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i> Cancelar
                                    </a>
                                    {{ form.submit(class="btn btn-primary") }}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const precioTonelada = document.getElementById('precio_tonelada');
    const fibraKg = {{ carga.proceso_desmotado.kilos_fibra }};
    
    // Campos de gastos
    const deudaSemilla = document.getElementById('deuda_semilla');
    const descuentoPrestamos = document.getElementById('descuento_prestamos');
    const adelantos = document.getElementById('adelantos');
    const otrosGastos = document.getElementById('otros_gastos');
    
    // Resumen
    const resumenTotalBruto = document.getElementById('resumen_total_bruto');
    const resumenTotalGastos = document.getElementById('resumen_total_gastos');
    const resumenNetoPagar = document.getElementById('resumen_neto_pagar');
    const totalBrutoCalculado = document.getElementById('total_bruto_calculado');

    function calcularTotalBruto() {
        const precio = parseFloat(precioTonelada.value) || 0;
        
        if (precio > 0) {
            const totalBruto = (fibraKg / 1000) * precio;
            totalBrutoCalculado.value = totalBruto.toFixed(2);
            resumenTotalBruto.textContent = '$ ' + totalBruto.toFixed(2);
        } else {
            totalBrutoCalculado.value = '';
            resumenTotalBruto.textContent = '$ 0.00';
        }
        
        calcularResumen();
    }

    function calcularGastos() {
        const deuda = parseFloat(deudaSemilla.value) || 0;
        const descuento = parseFloat(descuentoPrestamos.value) || 0;
        const adelanto = parseFloat(adelantos.value) || 0;
        const otros = parseFloat(otrosGastos.value) || 0;
        
        return deuda + descuento + adelanto + otros;
    }

    function calcularResumen() {
        const totalBruto = parseFloat(totalBrutoCalculado.value) || 0;
        const totalGastos = calcularGastos();
        const netoPagar = totalBruto - totalGastos;
        
        resumenTotalGastos.textContent = '$ ' + totalGastos.toFixed(2);
        resumenNetoPagar.textContent = '$ ' + netoPagar.toFixed(2);
        
        if (netoPagar < 0) {
            resumenNetoPagar.className = 'text-danger';
        } else {
            resumenNetoPagar.className = 'text-success';
        }
    }

    // Event listeners
    precioTonelada.addEventListener('input', calcularTotalBruto);
    deudaSemilla.addEventListener('input', calcularResumen);
    descuentoPrestamos.addEventListener('input', calcularResumen);
    adelantos.addEventListener('input', calcularResumen);
    otrosGastos.addEventListener('input', calcularResumen);
    
    // Calcular al cargar
    calcularTotalBruto();
});
</script>
{% endblock %}